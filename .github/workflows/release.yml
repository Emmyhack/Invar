name: Release Pipeline

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: write
  packages: write

jobs:
  # Stage 1: Version Validation
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Make script executable
        run: chmod +x scripts/verify_version.sh

      - name: Run version validation
        id: extract
        run: |
          ./scripts/verify_version.sh "${{ github.ref }}"
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Validated release version: $VERSION"

  # Stage 2: Full CI Verification
  ci-verification:
    name: CI Verification
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (debug)
        run: cargo clippy --all --all-targets -- -D warnings

      - name: Run unit tests
        run: cargo test --lib --all

      - name: Run integration tests
        run: cargo test --test '*' --all 2>/dev/null || true

      - name: Run property-based tests
        run: cargo test --release --all

      - name: Run CLI tests
        run: cargo test --test '*' --release --all 2>/dev/null || true

      - name: Run all tests again (release mode)
        run: cargo test --release --all

      - name: Verify all tests pass
        run: echo "✓ All CI checks passed"

  # Stage 3: Security Audit
  security-audit:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}

      - name: Run cargo audit
        continue-on-error: true
        run: |
          cargo install cargo-audit --locked 2>/dev/null || true
          cargo audit --deny warnings || {
            echo "⚠ Audit warnings detected - review required"
            cargo audit
          }

      - name: Check for unsafe code blocks
        run: |
          echo "Scanning for unsafe code..."
          UNSAFE_COUNT=$(grep -r "unsafe {" crates/ 2>/dev/null | wc -l)
          if [ "$UNSAFE_COUNT" -gt 0 ]; then
            echo "Found $UNSAFE_COUNT unsafe blocks:"
            grep -r "unsafe {" crates/ 2>/dev/null || true
            echo "Verify all have proper justification and SAFETY comments"
          fi
          echo "✓ Unsafe code review complete"

      - name: Verify rust-toolchain.toml pinned
        run: |
          if ! grep -q "channel = " rust-toolchain.toml; then
            echo "ERROR: rust-toolchain.toml must pin Rust version"
            exit 1
          fi
          echo "✓ Rust toolchain is pinned"

      - name: Verify Cargo.lock committed
        run: |
          git ls-files Cargo.lock | grep -q Cargo.lock || {
            echo "ERROR: Cargo.lock must be committed"
            exit 1
          }
          echo "✓ Cargo.lock is committed"

      - name: Verify lockfile unchanged
        run: |
          cargo metadata --locked > /dev/null 2>&1 || {
            echo "ERROR: Cargo.lock is out of sync with Cargo.toml"
            exit 1
          }
          echo "✓ Lockfile is in sync"

  # Stage 4: Build Matrix (6 Platforms - Sequential to avoid resource contention)
  build-linux-x86_64:
    name: Build (x86_64-linux-gnu)
    runs-on: ubuntu-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: linux-x86_64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --locked --target x86_64-unknown-linux-gnu

      - name: Strip binary
        run: strip target/x86_64-unknown-linux-gnu/release/invar

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-x86_64-linux-gnu
          path: target/x86_64-unknown-linux-gnu/release/invar

  build-linux-musl:
    name: Build (x86_64-linux-musl)
    runs-on: ubuntu-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install musl-tools
        run: sudo apt-get install -y musl-tools

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: linux-musl-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --locked --target x86_64-unknown-linux-musl

      - name: Strip binary
        run: strip target/x86_64-unknown-linux-musl/release/invar

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-x86_64-linux-musl
          path: target/x86_64-unknown-linux-musl/release/invar

  build-linux-aarch64:
    name: Build (aarch64-linux-gnu)
    runs-on: ubuntu-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install aarch64 toolchain
        run: sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: linux-aarch64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: |
          cargo build --release --locked --target aarch64-unknown-linux-gnu

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-aarch64-linux-gnu
          path: target/aarch64-unknown-linux-gnu/release/invar

  build-macos-x86_64:
    name: Build (x86_64-darwin)
    runs-on: macos-12
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: macos-x86_64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --locked --target x86_64-apple-darwin

      - name: Strip binary
        run: strip target/x86_64-apple-darwin/release/invar

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-x86_64-apple-darwin
          path: target/x86_64-apple-darwin/release/invar

  build-macos-aarch64:
    name: Build (aarch64-darwin)
    runs-on: macos-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: macos-aarch64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --locked --target aarch64-apple-darwin

      - name: Strip binary
        run: strip target/aarch64-apple-darwin/release/invar

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-aarch64-apple-darwin
          path: target/aarch64-apple-darwin/release/invar

  build-windows-x86_64:
    name: Build (x86_64-windows)
    runs-on: windows-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: windows-x86_64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --locked --target x86_64-pc-windows-msvc

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: invar-x86_64-pc-windows-msvc
          path: target/x86_64-pc-windows-msvc/release/invar.exe

  # Stage 5: Reproducibility Verification
  verify-reproducibility:
    name: Verify Reproducible Build
    runs-on: ubuntu-latest
    needs: [validate-version, ci-verification, security-audit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: verify-repro-${{ hashFiles('**/Cargo.lock') }}

      - name: First clean build
        run: |
          cargo build --release --locked --target x86_64-unknown-linux-gnu
          sha256sum target/x86_64-unknown-linux-gnu/release/invar > /tmp/build1.sha256
          cat /tmp/build1.sha256

      - name: Clean build artifacts
        run: cargo clean

      - name: Second clean build
        run: |
          cargo build --release --locked --target x86_64-unknown-linux-gnu
          sha256sum target/x86_64-unknown-linux-gnu/release/invar > /tmp/build2.sha256
          cat /tmp/build2.sha256

      - name: Verify determinism
        run: |
          if diff /tmp/build1.sha256 /tmp/build2.sha256; then
            echo "✓ Build is deterministic and reproducible"
          else
            echo "ERROR: Builds are not deterministic!"
            exit 1
          fi

  # Stage 6: Package Artifacts
  package-artifacts:
    name: Package Artifacts
    runs-on: ubuntu-latest
    needs: [validate-version, build-linux-x86_64, build-linux-musl, build-linux-aarch64, build-macos-x86_64, build-macos-aarch64, build-windows-x86_64, verify-reproducibility]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: binaries

      - name: Create distribution packages
        run: |
          mkdir -p dist
          VERSION="${{ needs.validate-version.outputs.version }}"
          
          echo "Creating distribution packages for version $VERSION"
          
          # Linux x86_64 (glibc)
          mkdir -p invar-v${VERSION}-x86_64-unknown-linux-gnu
          cp binaries/invar-x86_64-linux-gnu/invar invar-v${VERSION}-x86_64-unknown-linux-gnu/
          cp LICENSE README.md invar-v${VERSION}-x86_64-unknown-linux-gnu/
          echo "$VERSION" > invar-v${VERSION}-x86_64-unknown-linux-gnu/VERSION
          tar czf dist/invar-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz invar-v${VERSION}-x86_64-unknown-linux-gnu
          
          # Linux x86_64 (musl)
          mkdir -p invar-v${VERSION}-x86_64-unknown-linux-musl
          cp binaries/invar-x86_64-linux-musl/invar invar-v${VERSION}-x86_64-unknown-linux-musl/
          cp LICENSE README.md invar-v${VERSION}-x86_64-unknown-linux-musl/
          echo "$VERSION" > invar-v${VERSION}-x86_64-unknown-linux-musl/VERSION
          tar czf dist/invar-v${VERSION}-x86_64-unknown-linux-musl.tar.gz invar-v${VERSION}-x86_64-unknown-linux-musl
          
          # Linux aarch64
          mkdir -p invar-v${VERSION}-aarch64-unknown-linux-gnu
          cp binaries/invar-aarch64-linux-gnu/invar invar-v${VERSION}-aarch64-unknown-linux-gnu/
          cp LICENSE README.md invar-v${VERSION}-aarch64-unknown-linux-gnu/
          echo "$VERSION" > invar-v${VERSION}-aarch64-unknown-linux-gnu/VERSION
          tar czf dist/invar-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz invar-v${VERSION}-aarch64-unknown-linux-gnu
          
          # macOS x86_64
          mkdir -p invar-v${VERSION}-x86_64-apple-darwin
          cp binaries/invar-x86_64-apple-darwin/invar invar-v${VERSION}-x86_64-apple-darwin/
          cp LICENSE README.md invar-v${VERSION}-x86_64-apple-darwin/
          echo "$VERSION" > invar-v${VERSION}-x86_64-apple-darwin/VERSION
          tar czf dist/invar-v${VERSION}-x86_64-apple-darwin.tar.gz invar-v${VERSION}-x86_64-apple-darwin
          
          # macOS aarch64
          mkdir -p invar-v${VERSION}-aarch64-apple-darwin
          cp binaries/invar-aarch64-apple-darwin/invar invar-v${VERSION}-aarch64-apple-darwin/
          cp LICENSE README.md invar-v${VERSION}-aarch64-apple-darwin/
          echo "$VERSION" > invar-v${VERSION}-aarch64-apple-darwin/VERSION
          tar czf dist/invar-v${VERSION}-aarch64-apple-darwin.tar.gz invar-v${VERSION}-aarch64-apple-darwin
          
          # Windows
          mkdir -p invar-v${VERSION}-x86_64-pc-windows-msvc
          cp binaries/invar-x86_64-pc-windows-msvc/invar.exe invar-v${VERSION}-x86_64-pc-windows-msvc/
          cp LICENSE README.md invar-v${VERSION}-x86_64-pc-windows-msvc/
          echo "$VERSION" > invar-v${VERSION}-x86_64-pc-windows-msvc/VERSION
          cd invar-v${VERSION}-x86_64-pc-windows-msvc
          zip -r ../dist/invar-v${VERSION}-x86_64-pc-windows-msvc.zip . 
          cd ..
          
          ls -lh dist/

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v3
        with:
          name: packages
          path: dist/
          retention-days: 7

  # Stage 7: Generate Checksums
  generate-checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [validate-version, package-artifacts]
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v3
        with:
          name: packages
          path: dist

      - name: Generate SHA256SUMS
        run: |
          cd dist
          sha256sum * | tee SHA256SUMS
          echo ""
          echo "SHA256SUMS file created:"
          cat SHA256SUMS

      - name: Upload checksums
        uses: actions/upload-artifact@v3
        with:
          name: checksums
          path: dist/SHA256SUMS
          retention-days: 30

  # Stage 8: Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate-version, ci-verification, security-audit, verify-reproducibility]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Publish to crates.io
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          if [ -z "$CRATES_IO_TOKEN" ]; then
            echo "⚠ CRATES_IO_TOKEN not configured"
            echo "Cannot publish to crates.io without token"
            echo "Set CRATES_IO_TOKEN GitHub secret to enable publishing"
            exit 0
          fi
          
          echo "Publishing release to crates.io..."
          VERSION="${{ needs.validate-version.outputs.version }}"
          
          # Publish in dependency order
          for crate in "invar-core" "invar-dsl-parser" "invar-cli"; do
            echo ""
            echo "Publishing $crate v$VERSION..."
            cargo publish -p "$crate" --locked --token "$CRATES_IO_TOKEN" 2>&1 | tee /tmp/publish.log
            
            if grep -q "already uploaded" /tmp/publish.log; then
              echo "✓ $crate v$VERSION already published"
            else
              echo "✓ Successfully published $crate v$VERSION"
              # Wait for crates.io index update
              sleep 15
            fi
          done
          
          echo "✓ crates.io publication complete"

  # Stage 9: GitHub Release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, generate-checksums, publish-crates]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download packages
        uses: actions/download-artifact@v3
        with:
          name: packages
          path: dist

      - name: Download checksums
        uses: actions/download-artifact@v3
        with:
          name: checksums
          path: checksums

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          awk "/^## \[$VERSION\]/,/^## \[/ {print}" CHANGELOG.md | head -n -1 > /tmp/changelog.txt
          cat /tmp/changelog.txt

      - name: Create release notes with installation instructions
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          
          # Start with changelog
          cat /tmp/changelog.txt > /tmp/release_notes.md
          
          # Add installation section
          cat >> /tmp/release_notes.md <<'EOF'
          
          ## Installation
          
          Install the latest version with:
          
          ```bash
          cargo install invar-cli --version VERSION
          ```
          
          Or download pre-built binaries from the Assets section below.
          
          ## Verification
          
          Verify artifact integrity by comparing checksums:
          
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          ## Multi-Platform Binaries
          
          Pre-built binaries are available for:
          - **Linux (x86_64, glibc)**: Standard Linux distributions
          - **Linux (x86_64, musl)**: Alpine and other musl-based systems
          - **Linux (aarch64)**: ARM64 Linux servers
          - **macOS (Intel)**: x86_64 Mac systems
          - **macOS (Apple Silicon)**: aarch64 M1/M2/M3 Macs
          - **Windows (x86_64)**: Windows 10/11
          
          All binaries are deterministically built and reproducible.
          EOF
          
          # Substitute version
          sed -i "s/VERSION/$VERSION/g" /tmp/release_notes.md
          cat /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate-version.outputs.version }}
          body_path: /tmp/release_notes.md
          files: |
            dist/invar-*.tar.gz
            dist/invar-*.zip
            checksums/SHA256SUMS
          draft: false
          prerelease: ${{ contains(needs.validate-version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Final Success
  release-success:
    name: Release Complete
    runs-on: ubuntu-latest
    needs: [validate-version, github-release]
    if: success()
    steps:
      - name: Release Summary
        run: |
          echo "=========================================="
          echo "✓ RELEASE PIPELINE COMPLETED SUCCESSFULLY"
          echo "=========================================="
          echo "Version: ${{ needs.validate-version.outputs.version }}"
          echo ""
          echo "Deliverables:"
          echo "  ✓ Multi-platform binaries built"
          echo "  ✓ Reproducible build verified"
          echo "  ✓ SHA256 checksums generated"
          echo "  ✓ Published to crates.io"
          echo "  ✓ GitHub release created"
          echo ""
          echo "Installation:"
          echo "  cargo install invar-cli --version ${{ needs.validate-version.outputs.version }}"
          echo ""
          echo "Verification:"
          echo "  sha256sum -c SHA256SUMS"



