name: Release Build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-matrix:
    name: Build ${{ matrix.artifact }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: invar-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: invar-linux-aarch64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: invar-darwin-x86_64
          - os: macos-13-xlarge
            target: aarch64-apple-darwin
            artifact: invar-darwin-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: invar-windows-x86_64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Test
        run: cargo test --release --target ${{ matrix.target }} --locked

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} --locked

      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: strip target/${{ matrix.target }}/release/invar

      - name: Compute SHA256
        id: checksum
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            sha256sum "target/${{ matrix.target }}/release/invar.exe" | awk '{print $1}' > checksum.txt
          else
            sha256sum "target/${{ matrix.target }}/release/invar" | awk '{print $1}' > checksum.txt
          fi
          echo "sha256=$(cat checksum.txt)" >> $GITHUB_OUTPUT

      - name: Create artifact
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARTIFACT_NAME="${{ matrix.artifact }}-${VERSION}"
          mkdir -p artifacts
          
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp "target/${{ matrix.target }}/release/invar.exe" "artifacts/${ARTIFACT_NAME}.exe"
          else
            cp "target/${{ matrix.target }}/release/invar" "artifacts/${ARTIFACT_NAME}"
          fi
          
          cp checksum.txt "artifacts/${ARTIFACT_NAME}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-${{ matrix.target }}
          path: artifacts/

  create-release:
    name: Create GitHub Release
    needs: build-matrix
    runs-on: ubuntu-latest
    if: success()

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release Notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "## Invar ${VERSION}" > release_notes.md
          echo "" >> release_notes.md
          echo "### Artifacts" >> release_notes.md
          echo "" >> release_notes.md
          for dir in release-*; do
            for file in ${dir}/*; do
              if [[ $file == *.sha256 ]]; then
                echo "- $(basename $file) \`$(cat $file)\`" >> release_notes.md
              fi
            done
          done
          echo "" >> release_notes.md
          echo "### Verification" >> release_notes.md
          echo "" >> release_notes.md
          echo "Verify integrity:" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "sha256sum -c *.sha256" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          cat release_notes.md

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          draft: false
          prerelease: false
          bodyFile: release_notes.md
          artifacts: "release-*/*"

  verify-reproducibility:
    name: Verify Reproducibility
    needs: build-matrix
    runs-on: ubuntu-latest
    if: success()

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Verify checksums
        run: |
          echo "Verifying checksums..."
          cd release-x86_64-unknown-linux-gnu
          sha256sum -c *.sha256
          echo "All checksums verified!"

      - name: Verify binary execution
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BINARY="release-x86_64-unknown-linux-gnu/invar-linux-x86_64-${VERSION}"
          chmod +x "${BINARY}"
          "${BINARY}" --version || echo "Version check failed (expected if binary not fully functional)"

